<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Calculadora — Precificador de Crochê</title>
  <link rel="stylesheet" href="css/home.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
  <script>
    window.API_BASE = 'https://crochet-calculator-backend.onrender.com/api/';
  </script>
</head>
<body>
  <div class="container">
    <!-- Header removed: managed by index.html -->

    <!-- Navbar removed: navigation is handled by frontend/index.html -->

    <main>
      <section class="hero">
        <h2>Calculadora de Preços</h2>
        <p>Preencha os dados abaixo e obtenha um preço sugerido automaticamente.</p>
      </section>

      <form id="calc-form" class="card" onsubmit="handleCalculate(event)">
        <div style="display:grid;grid-template-columns:1fr;gap:0.75rem;">
          <label>Título da Peça
            <input id="pieceTitle" type="text" placeholder="Ex: Cachecol Azul">
          </label>
          <label>Custo do Material (R$)
            <input id="materialCost" type="number" step="0.01" value="15.00" required>
          </label>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;">
            <label>Horas<input id="hours" type="number" min="0" value="3"></label>
            <label>Minutos<input id="minutes" type="number" min="0" max="59" value="45"></label>
            <label>Valor/Hora (R$)<input id="hourlyRate" type="number" step="0.01" value="20.00"></label>
          </div>
          <label>Despesas Fixas/Extras (R$)
            <input id="fixedExpenses" type="number" step="0.01" value="5.00" required>
          </label>
          <label>Margem de Lucro (%)
            <input id="profitMargin" type="number" min="1" max="99" value="30" required>
          </label>
          <button class="btn btn-primary" type="submit">Calcular Preço Sugerido</button>
        </div>
      </form>

      <div id="result-area" class="card" style="display:none;margin-top:1rem;">
        <h3>Resultado do Cálculo</h3>
        <div><strong>Custo Mão de Obra:</strong> <span id="labor-cost">R$ 0,00</span></div>
        <div><strong>Custo Total:</strong> <span id="total-cost">R$ 0,00</span></div>
        <div style="margin-top:.5rem;background:var(--crochet-accent);padding:.5rem;border-radius:8px;display:flex;justify-content:space-between;align-items:center;">
          <strong>PREÇO SUGERIDO:</strong>
          <span id="selling-price" style="font-size:1.25rem;font-weight:800;">R$ 0,00</span>
        </div>
      </div>
    </main>

    <!-- Footer removed: managed by index.html -->
  </div>

  <script>
    (function(){ const y = document.getElementById('year'); if(y) y.textContent = new Date().getFullYear(); })();
    function formatBR(number){ return 'R$ ' + Number(number).toFixed(2).replace('.', ','); }
    async function handleCalculate(e){
      e.preventDefault();
      const pieceTitle = document.getElementById('pieceTitle').value.trim();
      const materialCost = parseFloat(document.getElementById('materialCost').value)||0;
      const hours = parseInt(document.getElementById('hours').value)||0;
      const minutes = parseInt(document.getElementById('minutes').value)||0;
      const hourlyRate = parseFloat(document.getElementById('hourlyRate').value)||0;
      const fixedExpenses = parseFloat(document.getElementById('fixedExpenses').value)||0;
      const profitMargin = parseFloat(document.getElementById('profitMargin').value)||0;
      if(profitMargin<=0||profitMargin>=100){alert('A margem deve ser entre 1 e 99%');return;}

      const data = { pieceTitle, materialCost, hours, minutes, hourlyRate, fixedExpenses, profitMargin };

      try{
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem('access_token');
        if(token) headers['Authorization'] = 'Bearer ' + token;

        const res = await fetch(window.API_BASE + '/calculate', {
          method: 'POST',
          headers,
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if(!res.ok) return alert(result.error || 'Erro no cálculo');

        document.getElementById('labor-cost').textContent = formatBR(result.labor_cost);
        document.getElementById('total-cost').textContent = formatBR(result.total_cost);
        document.getElementById('selling-price').textContent = formatBR(result.selling_price);
        document.getElementById('result-area').style.display='block';
      }catch(err){
        console.error(err);
        alert('Erro ao conectar com a API. Verifique CORS e API_BASE.');
      }
    }
  </script>
</body>
</html>
